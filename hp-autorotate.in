#!/bin/rc
fn die {
  echo $* >[1=2]
  exit 1
}

fn sigterm {
  rotate_it NONE normal
  rm $pidfile
}

fn rotate_it {
  for (i in $inputdevs) {
    xsetwacom set $i Rotate $1
  }
  xrandr -o $2
}

if (! test -e /sys/devices/platform/hp-wmi/tablet) {
  if (lsmod | grep '^hp_wmi' > /dev/null) {
    die 'Sure your machine is a tablet?'
  } else {
    die 'hp_wmi driver not loaded'
  }
}

test -z $DISPLAY && die '$DISPLAY not set'

pidfile=$HOME/.`{basename $0}^-lock
test -e $pidfile && die 'Already running? if not, try removing' $pidfile

echo $pid > $pidfile

inputdevs=`{
  xinput --list |
  grep 'Wacom.* \(touch\|eraser\|stylus\)' |
  sed 's/.*id=\([0-9]*\).*/\1/'
}

old=n
while (true) {
  new=`{cat /sys/devices/platform/hp-wmi/tablet}
  if (! ~ $new $old) {
    switch ($new) {
    # also it's possible:
    #   rotate_it CCW  left
    #   rotate_it CW   right
      case 1
        rotate_it HALF inverted
      case 0
        rotate_it NONE normal
    }
    old=$new
  }
  sleep 1
}
