#!/bin/rc
#
# Copyright (C) 2011  Ismael Luceno
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#

fn die {
  echo $* >[1=2]
  exit 1
}

fn sigterm {
  rotate_it NONE normal
  rm $pidfile
}

fn rotate_it {
  for (i in $inputdevs) {
    xsetwacom set $i Rotate $1
  }
  xrandr -o $2
}

if (! test -e /sys/devices/platform/hp-wmi/tablet) {
  if (awk '/^hp_wmi/{exit 1}' /proc/modules) {
    die 'hp_wmi driver not loaded'
  } else {
    die 'Are you sure your machine is an HP tablet?'
  }
}

test -z $DISPLAY && die '$DISPLAY not set'

pidfile=$HOME/.`{basename $0}^-lock
test -e $pidfile && die 'Already running? if not, try removing' $pidfile

echo $pid > $pidfile

inputdevs=`{
  xinput --list |
  awk -F'(id=| *\[)' '/Wacom.* (touch|eraser|stylus)/{print $2}'
}

old=n
while (true) {
  new=`{cat /sys/devices/platform/hp-wmi/tablet}
  if (! ~ $new $old) {
    switch ($new) {
    # also it's possible:
    #   rotate_it CCW  left
    #   rotate_it CW   right
      case 1
        rotate_it HALF inverted
      case 0
        rotate_it NONE normal
    }
    old=$new
  }
  sleep 1
}
